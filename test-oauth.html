<!DOCTYPE html>
<html>
<head>
    <title>OAuth Test</title>
</head>
<body>
    <h1>Google OAuth Test</h1>
    <button onclick="testOAuth()">Test Google OAuth</button>
    <div id="result"></div>

    <script>
        async function testOAuth() {
            try {
                // Get the OAuth URL from backend
                const response = await fetch('http://localhost:10000/auth/google');
                const data = await response.json();
                
                console.log('OAuth URL:', data.url);
                document.getElementById('result').innerHTML = `
                    <p>OAuth URL generated:</p>
                    <a href="${data.url}" target="_blank">Click here to test OAuth</a>
                    <br><br>
                    <p>Or copy this URL: ${data.url}</p>
                `;
                
                // Open in new window
                const authWindow = window.open(data.url, 'oauth-test', 'width=500,height=600');
                
                // Poll for completion
                const pollTimer = setInterval(async () => {
                    try {
                        const statusResponse = await fetch('http://localhost:10000/auth/status');
                        const statusData = await statusResponse.json();
                        console.log('Auth status:', statusData);
                        
                        if (statusData.isAuthenticated) {
                            clearInterval(pollTimer);
                            document.getElementById('result').innerHTML += `
                                <br><br>
                                <p style="color: green;">âœ… Authentication successful!</p>
                                <p>Email: ${statusData.email}</p>
                            `;
                            try {
                                authWindow.close();
                            } catch (e) {
                                console.log('Could not close window');
                            }
                        }
                    } catch (e) {
                        console.error('Polling error:', e);
                    }
                }, 1000);
                
                // Stop polling after 5 minutes
                setTimeout(() => {
                    clearInterval(pollTimer);
                }, 300000);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>